"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),File=function(){function e(t,n){_classCallCheck(this,e),this.fileName=t,this.syncing=!1,this.syncingAddedData=null,this.timeExtension=0,this.timeLastRead=0,this.fileStats=null,this.dataObject={},this.client=n}return _createClass(e,[{key:"query",value:function(e){return this.toDataArray(this.queryHelper(e))}},{key:"queryHelper",value:function(e){return"function"==typeof e?this.queryByFunction(e):null==e?this.dataObject:this.queryByValue(e)}},{key:"remove",value:function(e){var t,n;this.scheduleSync(),n=this.queryHelper(e);for(t in n)n.hasOwnProperty(t)&&delete this.dataObject[t];return this.query(e)}},{key:"update",value:function(e,t){var n,a,i,r,l,o;r=this.queryHelper(e);for(a in r)if(r.hasOwnProperty(a)){l=r[a],i=this.clone(l);for(n in t)t.hasOwnProperty(n)&&(o=t[n],i[n]=o);this.remove(this.dataObject[a]),this.insert(i)}return this.query(e)}},{key:"updateByFunction",value:function(e,t){var n=this.queryHelper(e);console.debug("[File.updateByFunction] affected rows: ",this.toDataArray(n).length);for(id in n)if(n.hasOwnProperty(id)){var a=n[id],i=t(this.clone(a));this.remove(this.dataObject[id]),this.insert(i)}return this.query(e)}},{key:"insert",value:function(e){this.scheduleSync();var t=this.getNextId();return this.dataObject[t]=e}},{key:"queryByFunction",value:function(e){var t,n,a,i;a={},n=this.dataObject;for(t in n)n.hasOwnProperty(t)&&(i=n[t],e(this.clone(i))===!0&&(a[t]=this.clone(i)));return a}},{key:"queryByValue",value:function(e){var t,n,a,i,r,l;r={},i=this.dataObject;for(a in i)if(i.hasOwnProperty(a)){l=i[a],n=null;for(t in e)e.hasOwnProperty(t)&&(n=l[t]===e[t]&&(null===n||n&&!0));n&&(r[a]=this.clone(l))}return r}},{key:"getNextId",value:function(){var e,t;return t=(new Date).getTime(),this.timeExtension++,e=this.timeExtension%1e3,e<10?t+"00"+e:e<100?t+"0"+e:""+t+e}},{key:"scheduleSync",value:function(){var e=this;if(!this.syncing)return this.syncing=!0,setTimeout(function(){e.sync()},0)}},{key:"sync",value:function(){var e=this;console.debug("[File.sync] start sync","fileStats:",this.fileStats);var t,n;this.syncing=!1,n=(new Date).getTime(),t="0",null!=this.fileStats&&(t=this.fileStats.versionTag),this.readStat().then(function(a){if(console.debug("[File.sync] after readStat",t,e.fileStats.versionTag),t!==e.fileStats.versionTag){var i=e.clone(e.dataObject);console.debug("[File.sync] version tags do differ"),e.readFile().then(function(t){console.debug("[File.sync] after readFile"),e.dataObject=e.merge(i,e.dataObject),e.timeLastRead=n,e.writeFile()})}else e.timeLastRead=n,e.writeFile()})}},{key:"getVersionTag",value:function(){return this.fileStats.versionTag}},{key:"getSize",value:function(){var e;return e=0,null!=this.syncingAddedData&&(e=JSON.stringify(this.syncingAddedData).length),JSON.stringify(this.dataObject).length+e}},{key:"getName",value:function(){return this.fileName}},{key:"getData",value:function(){return this.clone(this.dataObject)}},{key:"getDataArray",value:function(){return this.toDataArray(this.dataObject)}},{key:"toDataArray",value:function(e){var t,n;t=[];for(n in e)t.push(e[n]);return this.clone(t)}},{key:"readFile",value:function(){var e=this;return new Promise(function(t,n){e.client.readFile(e.fileName,function(n,a,i){e.error(n)&&(e.dataObject=JSON.parse(a),e.fileStats=i,t(e.dataObject))})})}},{key:"writeFile",value:function(){var e=this;return new Promise(function(t,n){e.client.writeFile(e.fileName,JSON.stringify(e.dataObject),function(n,a){e.error(n)&&(e.fileStats=a,t(a))})})}},{key:"readStat",value:function(){var e=this;return new Promise(function(t,n){e.client.stat(e.fileName,function(n,a){e.error(n)&&(console.debug("[readStat] stats:",a),e.fileStats=a,t(a))})})}},{key:"error",value:function(e){var t;if(t=!0,null!=e)switch(e.status){case 404:t=!1,console.log("File not found - creating new file"),this.writeFile();break;case 503:t=!1,console.log("Too many requests - try again in 1000ms"),setTimeout(this.sync,1e3);break;default:console.error(e),t=!1}return t}},{key:"merge",value:function(e,t){var n,a,i;console.log("MERGING"),a={},i=0;for(n in t)t.hasOwnProperty(n)&&(null!=e[n]&&(a[n]=t[n]),null==e[n]&&(i=parseInt(n.slice(0,13)),i>this.timeLastRead&&(a[n]=e[n])));return a}},{key:"clone",value:function(e){var t=JSON.stringify(e);return JSON.parse(t)}},{key:"call",value:function(e){return"function"==typeof e?e():void 0}}]),e}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),Table=function(){function e(t,n,a,i,r){var l=this;_classCallCheck(this,e),n=n||!1,i=i||!1,r=r||!1;var o,s;if(this.tableFileData={},this.dataFileObjects=[],this.data=[],this.client=a,this.tableName=t,s=new File(t,a),n){var u=s.readFile();this.data[0]={maxSize:62500,dataFiles:[]},"Array"==typeof n&&(this.data[0].fields=n),o=this.createNewDatafile(),this.dataFileObjects.push(o),this.data[0].dataFiles.push(o.getName()),s.insert(this.data[0]),this.tableFileData=this.data[0],u.then(function(e){i&&i(o.getName())})}else s.readFile().then(function(e){var n,a;l.data=s.getDataArray(),l.tableFileData=l.data[0];var o=[],u=!0,c=!1,f=void 0;try{for(var y,h=l.tableFileData.dataFiles[Symbol.iterator]();!(u=(y=h.next()).done);u=!0)n=y.value,a=new File(n,l.client),l.dataFileObjects.push(a),o.push(a.readFile())}catch(e){c=!0,f=e}finally{try{!u&&h.return&&h.return()}finally{if(c)throw f}}Promise.all(o).then(function(e){i&&(console.debug("[Table.constructor] successfully loaded files for",t,e),i(e))}).catch(function(e){console.error("[Table.constructor] error when loading file:",e),r&&r(a.getName())})})}return _createClass(e,[{key:"getTableFields",value:function(){return this.tableFileData.fields}},{key:"updateTableData",value:function(){var e;dataFiles=[];var t=!0,n=!1,a=void 0;try{for(var i,r=this.dataFileObjects[Symbol.iterator]();!(t=(i=r.next()).done);t=!0)e=i.value,dataFiles.push(e.getName())}catch(e){n=!0,a=e}finally{try{!t&&r.return&&r.return()}finally{if(n)throw a}}return tableFile.update(void 0,{dataFiles:dataFiles})}},{key:"insert",value:function(e){var t=this.dataFileObjects[this.dataFileObjects.length-1];return t.getSize()>this.tableFileData.maxSize&&(t=this.createNewDatafile(),this.dataFileObjects.push(t),this.tableFileData.dataFiles.push(t.getName()),this.updateTableData()),t.insert(e)}},{key:"query",value:function(e,t,n,a){var i,r,l;e||(e=null),t||(t=null),r=[];var o=!0,s=!1,u=void 0;try{for(var c,f=this.dataFileObjects[Symbol.iterator]();!(o=(c=f.next()).done);o=!0)i=c.value,r=r.concat(i.query(e))}catch(e){s=!0,u=e}finally{try{!o&&f.return&&f.return()}finally{if(s)throw u}}if(null!=t&&t instanceof Array){var y=!0,h=!1,d=void 0;try{for(var v,b=t[Symbol.iterator]();!(y=(v=b.next()).done);y=!0)l=v.value,r.sort(this.sortResults(l[0],l.length>1?l[1]:null))}catch(e){h=!0,d=e}finally{try{!y&&b.return&&b.return()}finally{if(h)throw d}}}return n=n&&"number"==typeof n?n:null,a=a&&"number"==typeof a?a:null,n&&a?r=r.slice(n,n+a):n?r=r.slice(n):a&&(r=r.slice(n,a)),r}},{key:"update",value:function(e,t){var n=[],a=!0,i=!1,r=void 0;try{for(var l,o=this.dataFileObjects[Symbol.iterator]();!(a=(l=o.next()).done);a=!0)dfo=l.value,n=n.concat(dfo.updateByFunction(e,t))}catch(e){i=!0,r=e}finally{try{!a&&o.return&&o.return()}finally{if(i)throw r}}return n}},{key:"createNewDatafile",value:function(){var e,t;return t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t,n;return t=16*Math.random()|0,n="x"===e?t:3&t|8,n.toString(16)}),e=new File("_"+t,this.client),e.readFile(),e}},{key:"sortResults",value:function(e,t){return t||(t=null),function(n,a){var i="string"==typeof n[e]?n[e].toLowerCase():n[e],r="string"==typeof a[e]?a[e].toLowerCase():a[e];return"DESC"===t?i==r?0:i<r?1:-1:i==r?0:i>r?1:-1}}},{key:"call",value:function(e){return"function"==typeof e?e():void 0}}]),e}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),FileDB=function(){function e(t){_classCallCheck(this,e),this.apiKey=t,this.allTables={},e.file=File,this.client=null}return _createClass(e,[{key:"setupDropbox",value:function(e){var t=this,n=new Promise(function(e,n){t.client=new Dropbox.Client({key:t.apiKey}),t.client.authenticate(null,function(a){if(a)throw a;t.loadTables(e,n)})});n.then(function(t){console.debug("[setupDropbox] all promises resolved, calling callback function"),e()}).catch(function(e){console.error("[setupDropbox] Error on authentication or table initialization.",e)})}},{key:"query",value:function(e,t,n,a,i){return t||(t=null),n||(n=null),a||(a=null),i||(i=null),this.allTables[e].query(t,n,a,i)}},{key:"queryAll",value:function(e,t){return t?this.query(e,t.hasOwnProperty("query")?t.query:null,t.hasOwnProperty("sort")?t.sort:null,t.hasOwnProperty("start")?t.start:null,t.hasOwnProperty("limit")?t.limit:null):this.query(e)}},{key:"update",value:function(e,t,n){if(t||(t=null),"function"!=typeof n)return console.warn("updateFunction is empty, but required."),[];var a=this.allTables[e].update(t,n);return console.debug("[FileDB.update] result of update:",a),a}},{key:"rowCount",value:function(e){return this.query(e).length}},{key:"createTable",value:function(e,t){return this.allTables[e]=new Table(e,t,this.client)}},{key:"createTableWithData",value:function(e,t){("object"!==("undefined"==typeof t?"undefined":_typeof(t))||!t.length||t.length<1)&&error("Data supplied isn't in object form. Example: [{k:v,k:v},{k:v,k:v} ..]");var n=Object.keys(t[0]);this.createTable(e,n);for(var a=0;a<t.length;a++)this.insert(e,t[a]);return this.query(e)}},{key:"insert",value:function(e,t){return this.allTables[e].insert(t)}},{key:"tableFields",value:function(e){return this.allTables[e].getTableFields()}},{key:"isNew",value:function(){return 0===Object.keys(this.allTables).length}},{key:"loadTables",value:function(e,t){var n=this;this.client.readdir("/",function(a,i){a&&t(a);var r,l=[],o=!0,s=!1,u=void 0;try{for(var c,f=i[Symbol.iterator]();!(o=(c=f.next()).done);o=!0)r=c.value,"_"!==r[0]&&(console.debug("[loadTables] add promise for file",r),l.push(new Promise(function(e,t){n.allTables[r]=new Table(r,(!1),n.client,e,t)})))}catch(e){s=!0,u=e}finally{try{!o&&f.return&&f.return()}finally{if(s)throw u}}Promise.all(l).then(function(t){console.debug("[loadTables] all files loaded successfully, values:",t),e(t)}).catch(function(e){console.debug("[loadTables] failed loading at least one file, error of failed promise:",e),t(e)})})}}]),e}();